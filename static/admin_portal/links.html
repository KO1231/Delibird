<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Delibird Links - {{ domain }}</title>
        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <!-- Bootstrap Icons -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
        <style{% if style_nonce %} nonce="{{ style_nonce }}"{% endif %}>
            .status-badge {
                min-width: 60px;
            }

            .link-url {
                word-break: break-all;
            }

            .table-responsive {
                font-size: 0.9rem;
            }

            .header-section {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 2rem 0;
                margin-bottom: 2rem;
            }

            .stats-card {
                border-left: 4px solid;
                transition: transform 0.2s;
            }

            .stats-card:hover {
                transform: translateY(-2px);
            }

            .active-link {
                border-left-color: #28a745;
            }

            .inactive-link {
                border-left-color: #dc3545;
            }

            .total-link {
                border-left-color: #007bff;
            }

            .expired-row {
                background-color: #fff3cd;
            }

            .disabled-row {
                background-color: #f8d7da;
            }

            .max-uses-exceeded-row {
                background-color: #ffe5e5;
            }
        </style>
    </head>
    <body class="bg-light">
        <!-- Header -->
        <div class="header-section">
            <div class="container">
                <h1 class="mb-2"><i class="bi bi-link-45deg"></i> Delibird Links</h1>
                <p class="mb-0">Domain: <strong>{{ domain }}</strong></p>
            </div>
        </div>

        <div class="container">
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card stats-card total-link shadow-sm">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Total Links</h6>
                            <h2 class="card-title mb-0">{{ links|length }}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card stats-card active-link shadow-sm">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Active Links</h6>
                            <h2 class="card-title mb-0">{{ active_count }}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card stats-card inactive-link shadow-sm">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Inactive Links</h6>
                            <h2 class="card-title mb-0">{{ inactive_count }}</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Links Table -->
            <div class="card shadow">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-table"></i> Link Details</h5>
                </div>
                <div class="card-body p-0">
                    {% if links %}
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Slug</th>
                                    <th>Origin URL</th>
                                    <th>Status</th>
                                    <th>Active</th>
                                    <th>Uses</th>
                                    <th>Max Uses</th>
                                    <th>Expiration</th>
                                    <th>Query</th>
                                    <th>Created At</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set link_prefix = link_prefix + "/" if link_prefix else "" %}
                                {% for link in links %}
                                {% set is_active, inactive_reason = link.check_active() %}
                                <tr class="{% if not is_active %}
                                {% if link.disabled %}disabled-row
                                {% elif link.expiration_date and link.expiration_date < now %}expired-row
                                {% elif link.max_uses and link.uses >= link.max_uses %}max-uses-exceeded-row
                                {% endif %}
                            {% endif %}">
                                    <!-- Slug -->
                                    <td>
                                        <strong>
                                            <a href="https://{{domain}}/{{link_prefix}}{{link.link_slug}}" target="_blank"
                                               class="text-decoration-none">
                                                {{ link.link_slug }}
                                            </a>
                                        </strong>
                                        {% if link.disabled %}
                                        <br><span class="badge bg-secondary"><i class="bi bi-x-circle"></i> Disabled</span>
                                        {% endif %}
                                    </td>

                                    <!-- Origin URL -->
                                    <td class="link-url">
                                        <a href="{{ link.link_origin }}" target="_blank" class="text-decoration-none">
                                            {{ link.link_origin }}
                                        </a>
                                        {% if not is_active and link.expired_origin %}
                                        <br><small class="text-muted">Expired Origin: {{ link.expired_origin }}</small>
                                        {% endif %}
                                    </td>

                                    <!-- HTTP Status -->
                                    <td>
                                    <span class="badge status-badge {% if link.status.value < 300 %}bg-success{% elif link.status.value < 400 %}bg-info{% else %}bg-warning{% endif %}">
                                        {{ link.status.value }}
                                    </span>
                                    </td>

                                    <!-- Active Status -->
                                    <td>
                                        {% if is_active %}
                                        <span class="badge bg-success"><i class="bi bi-check-circle"></i> Active</span>
                                        {% else %}
                                        <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Inactive</span>
                                        {% if inactive_reason %}
                                        <br><small class="text-muted">{{ inactive_reason.reason }}</small>
                                        {% endif %}
                                        {% endif %}
                                    </td>

                                    <!-- Uses -->
                                    <td>
                                        <span class="badge bg-primary">{{ link.uses }}</span>
                                    </td>

                                    <!-- Max Uses -->
                                    <td>
                                        {% if link.max_uses %}
                                        <span class="badge bg-warning text-dark">{{ link.max_uses }}</span>
                                        {% if link.uses >= link.max_uses %}
                                        <br><small class="text-danger"><i class="bi bi-exclamation-triangle"></i> Exceeded</small>
                                        {% endif %}
                                        {% else %}
                                        <span class="text-muted">âˆž</span>
                                        {% endif %}
                                    </td>

                                    <!-- Expiration Date -->
                                    <td>
                                        {% if link.expiration_date %}
                                        {{ link.expiration_date.strftime('%Y-%m-%d %H:%M') }}
                                        {% if link.expiration_date < now %}
                                        <br><span class="badge bg-danger"><i class="bi bi-clock"></i> Expired</span>
                                        {% else %}
                                        <br><span class="badge bg-info"><i class="bi bi-clock"></i> Active</span>
                                        {% endif %}
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>

                                    <!-- Query Settings -->
                                    <td>
                                        {% if link.query_omit %}
                                        <span class="badge bg-secondary"><i class="bi bi-slash-circle"></i> Omit</span>
                                        {% else %}
                                        <span class="badge bg-success"><i class="bi bi-check-circle"></i> Include</span>
                                        {% endif %}
                                        {% if link.query_whitelist %}
                                        <br><small class="text-muted">Whitelist: {{ link.query_whitelist|join(', ') }}</small>
                                        {% endif %}
                                    </td>

                                    <!-- Created At -->
                                    <td>
                                        <small>{{ link._model.created_at.strftime('%Y-%m-%d %H:%M') if link._model.created_at else '-' }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                        <p class="text-muted mt-3">No links found for this domain.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Legend -->
            {% if links %}
            <div class="card mt-4 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-info-circle"></i> Legend</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <span class="badge bg-success">Active</span> Link is currently active and usable
                        </div>
                        <div class="col-md-4">
                            <span class="badge bg-danger">Inactive</span> Link is disabled, expired, or max uses exceeded
                        </div>
                        <div class="col-md-4">
                            <div class="p-2 expired-row d-inline-block">Expired</div>
                            Expiration date has passed
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-4">
                            <div class="p-2 disabled-row d-inline-block">Disabled</div>
                            Link is manually disabled
                        </div>
                        <div class="col-md-4">
                            <div class="p-2 max-uses-exceeded-row d-inline-block">Max Uses</div>
                            Maximum usage count reached
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Footer -->
            <footer class="text-center text-muted my-4">
                <small>&copy; 2025 Kazuhiro Oka</small>
            </footer>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>
