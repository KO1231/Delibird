<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Delibird Links - {{ domain }}</title>
        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
        <!-- Bootstrap Icons -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" integrity="sha384-CK2SzKma4jA5H/MXDUU7i1TqZlCFaD4T01vtyDFvPlD97JQyS+IsSh1nI2EFbpyk" crossorigin="anonymous">
        <link rel="stylesheet" href="https://static.kazutech.jp/l/css/admin-portal.css">
    </head>
    <body class="bg-light">
        <!-- Header -->
        <div class="header-section">
            <div class="container">
                <h1 class="mb-2">
                    <i class="bi bi-link-45deg"></i> Delibird Links<span class="env-badge {{ delibird_environment.lower() }}">{{ delibird_environment.upper() }}</span>
                </h1>
                <p class="mb-0">Domain: <strong>{{ domain }}</strong></p>
            </div>
        </div>

        <div class="container">
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card stats-card total-link shadow-sm">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Total Links</h6>
                            <h2 class="card-title mb-0">{{ links|length }}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card stats-card active-link shadow-sm">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Active Links</h6>
                            <h2 class="card-title mb-0">{{ active_count }}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card stats-card inactive-link shadow-sm">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Inactive Links</h6>
                            <h2 class="card-title mb-0">{{ inactive_count }}</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create New Link Button -->
            <div class="mb-3">
                <button type="button" class="btn btn-primary btn-md" data-bs-toggle="modal" data-bs-target="#createLinkModal">
                    <i class="bi bi-plus-circle"></i> Create
                </button>
            </div>

            <!-- Links Table -->
            <div class="card shadow">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-table"></i> Link Details</h5>
                </div>
                <div class="card-body p-0">
                    {% if links %}
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Slug</th>
                                    <th>Origin</th>
                                    <th>Status</th>
                                    <th>Active</th>
                                    <th>Uses</th>
                                    <th>Limit</th>
                                    <th>Expiration (JST)</th>
                                    <th>Query</th>
                                    <th>Edit</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for link in links %}
                                {% set is_active, inactive_reason = link.check_active() %}
                                <tr class="{%- if not is_active %}
                                {%- if link.disabled %}disabled-row
                                {%- elif link.expiration_date and link.expiration_date < now %}expired-row
                                {%- elif link.max_uses and link.uses >= link.max_uses %}max-uses-exceeded-row
                                {%- endif %}
                                {%- endif %}">
                                    <!-- Slug -->
                                    <td class="link-slug">
                                        <strong>
                                            <a href="https://{{domain}}/{{link_prefix}}{{link.link_slug}}" target="_blank"
                                               class="text-decoration-none">
                                                {{ link.link_slug }}
                                            </a>
                                        </strong>
                                        {% if link.memo %}
                                        <i class="bi bi-sticky-fill text-warning ms-1"
                                           data-bs-toggle="tooltip"
                                           data-bs-placement="top"
                                           data-bs-html="true"
                                           title="{{ link.memo|replace('"', '&quot;')|replace('\n', '<br>') }}"></i>
                                        {% endif %}
                                        {% if link.tag %}
                                        <i class="bi bi-tags-fill text-info ms-1"
                                           data-bs-toggle="tooltip"
                                           data-bs-placement="top"
                                           data-bs-html="true"
                                           title="{{ link.tag|join(', ') }}"></i>
                                        {% endif %}
                                        {% if link.is_protected() %}
                                        <i class="bi bi-lock-fill ms-1"
                                           data-bs-toggle="tooltip"
                                           data-bs-placement="top"></i>
                                        {% endif %}
                                    </td>

                                    <!-- Origin -->
                                    <td class="link-origin">
                                        <a href="{{ link.link_origin }}" target="_blank" class="text-decoration-none">
                                            {{ link.link_origin }}
                                        </a>
                                        {% if not is_active and link.expired_origin %}
                                        <br><small class="text-muted">Expired Origin:<br>{{ link.expired_origin }}</small>
                                        {% endif %}
                                    </td>

                                    <!-- HTTP Status -->
                                    <td class="link-status">
                                    <span class="badge status-badge {% if link.status.value < 300 %}bg-success{% elif link.status.value < 400 %}bg-info{% else %}bg-warning{% endif %}">
                                        {{ link.status.value }}
                                    </span>
                                    </td>

                                    <!-- Active Status -->
                                    <td class="link-active">
                                        {% if is_active %}
                                        <span class="badge bg-success"><i class="bi bi-check-circle"></i> Active</span>
                                        {% else %}
                                        {% if not inactive_reason %}
                                        <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Inactive</span>
                                        {% else %}
                                        {% if inactive_reason.status.name == "EXPIRED" %}
                                        {% if link.expired_origin %}
                                        <span class="badge bg-expired"><i class="bi bi-clock-history"></i>
                                        {% else %}
                                        <span class="badge bg-danger"><i class="bi bi-x-circle"></i>
                                        {% endif %}
                                             Expired
                                        </span>
                                        {% elif inactive_reason.status.name == "MAX_USES_EXCEEDED" %}
                                        <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Exceeded</span>
                                        {% elif inactive_reason.status.name == "DISABLED" %}
                                        <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Disabled</span>
                                        {% else %}
                                        <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Unknown</span>
                                        <br><small class="text-muted">{{ inactive_reason.reason }}</small>
                                        {% endif %}
                                        {% endif %}
                                        {% endif %}
                                    </td>

                                    <!-- Uses -->
                                    <td>
                                        <span class="badge bg-primary">{{ link.uses }}</span>
                                    </td>

                                    <!-- Limit -->
                                    <td>
                                        <span class="badge {% if link.max_uses and link.uses >= link.max_uses %}bg-danger{% else %}bg-warning text-black{% endif %}">
                                        {% if link.max_uses %}{{ link.max_uses }}{% else %}∞{% endif %}
                                        </span>
                                    </td>

                                    <!-- Expiration Date -->
                                    <td class="link-expiration-date">
                                        {% if link.expiration_date %}
                                        {% if link.expiration_date < now %}<span class="text-danger">{% endif %}
                                        {{ link.expiration_date.strftime('%Y-%m-%d %H:%M') }}
                                        {% if link.expiration_date < now %}</span>{% endif %}
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>

                                    <!-- Query Settings -->
                                    <td class="link-query">
                                        {% if link.query_omit %}
                                        <span class="badge bg-secondary"><i class="bi bi-slash-circle"></i> Omit</span>
                                        {% else %}
                                        <span class="badge bg-success"><i class="bi bi-check-circle"></i>
                                        {% if link.query_whitelist %} Whitelist{% else %} Include{% endif %}
                                        </span>
                                        {% endif %}
                                    </td>

                                    <!-- Edit Button -->
                                    <td class="link-edit">
                                        <button type="button" class="btn btn-sm btn-outline-primary edit-link-btn"
                                                data-slug="{{ link.link_slug }}"
                                                data-origin="{{ link.link_origin }}"
                                                data-status="{{ link.status.value }}"
                                                data-disabled="{{ 'true' if link.disabled else 'false' }}"
                                                data-max-uses="{{ link.max_uses or '' }}"
                                                data-expiration="{{ link.expiration_date.strftime('%Y-%m-%dT%H:%M') if link.expiration_date else '' }}"
                                                data-expired-origin="{{ link.expired_origin or '' }}"
                                                data-passphrase="{{ link._passphrase or '' }}"
                                                data-query-omit="{{ 'true' if link.query_omit else 'false' }}"
                                                data-query-whitelist="{{ link.query_whitelist|join(',') if link.query_whitelist else '' }}"
                                                data-memo="{{ link.memo or '' }}"
                                                data-tag="{{ link.tag|join(',') if link.tag else '' }}"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editLinkModal">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                        <p class="text-muted mt-3">No links found for this domain.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Create Link Modal -->
            <div class="modal fade" id="createLinkModal" tabindex="-1" aria-labelledby="createLinkModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="createLinkModalLabel">
                                <i class="bi bi-plus-circle"></i> 新規リンク作成
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form id="createLinkForm">
                            <div class="modal-body">
                                <div class="row">
                                    <!-- Slug -->
                                    <div class="col-md-6 mb-3">
                                        <label for="linkSlug" class="form-label">Slug <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="linkSlug" name="link_slug" required
                                               pattern="[a-zA-Z0-9_\-/]+" title="英数字、ハイフン、アンダースコア、スラッシュのみ">
                                        <div class="form-text">英数字、ハイフン、アンダースコア、スラッシュのみ</div>
                                    </div>

                                    <!-- HTTP Status -->
                                    <div class="col-md-6 mb-3">
                                        <label for="status" class="form-label">HTTP Status <span class="text-danger">*</span></label>
                                        <select class="form-select" id="status" name="status" required>
                                            <option value="301">301 - Moved Permanently</option>
                                            <option value="302" selected>302 - Found</option>
                                            <option value="303">303 - See Other</option>
                                            <option value="307">307 - Temporary Redirect</option>
                                            <option value="308">308 - Permanent Redirect</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Origin -->
                                <div class="mb-3">
                                    <label for="linkOrigin" class="form-label">Origin <span class="text-danger">*</span></label>
                                    <input type="url" class="form-control" id="linkOrigin" name="link_origin" required
                                           placeholder="https://example.com/destination">
                                    <div class="form-text">リダイレクト先のURL</div>
                                </div>

                                <div class="row">
                                    <!-- Limit -->
                                    <div class="col-md-6 mb-3">
                                        <label for="maxUses" class="form-label">Limit</label>
                                        <input type="number" class="form-control" id="maxUses" name="max_uses" min="1"
                                               placeholder="無制限">
                                        <div class="form-text">最大使用回数（空欄で無制限）</div>
                                    </div>

                                    <!-- Expiration Date -->
                                    <div class="col-md-6 mb-3">
                                        <label for="expirationDate" class="form-label">Expiration Date</label>
                                        <input type="datetime-local" class="form-control" id="expirationDate" name="expiration_date">
                                        <div class="form-text">有効期限（空欄で無期限）</div>
                                    </div>
                                </div>

                                <!-- Query Settings -->
                                <div class="mb-3">
                                    <label class="form-label">Query String Settings</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="queryOmit" name="query_omit" value="true" checked>
                                        <label class="form-check-label" for="queryOmit">
                                            クエリパラメータを除外
                                        </label>
                                    </div>
                                </div>

                                <!-- Query Whitelist -->
                                <div class="mb-3 hidden-field" id="queryWhitelistContainer">
                                    <label for="queryWhitelist" class="form-label">Query Whitelist</label>
                                    <input type="text" class="form-control" id="queryWhitelist" name="query_whitelist"
                                           placeholder="param1,param2,param3" disabled>
                                    <div class="form-text">カンマ区切りで許可するクエリパラメータ名を指定</div>
                                </div>

                                <!-- Disabled -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="disabled" name="disabled" value="true">
                                        <label class="form-check-label" for="disabled">
                                            無効化（作成後に無効状態にする）
                                        </label>
                                    </div>
                                </div>

                                <!-- Expired Origin -->
                                <div class="mb-3">
                                    <label for="expiredOrigin" class="form-label">Expired Origin</label>
                                    <input type="url" class="form-control" id="expiredOrigin" name="expired_origin"
                                           placeholder="https://example.com/expired">
                                    <div class="form-text">期限切れ時のリダイレクト先URL（オプション）</div>
                                </div>

                                <!-- Passphrase -->
                                <div class="mb-3">
                                    <label for="passphrase" class="form-label">Passphrase</label>
                                    <div class="password-field-wrapper">
                                        <input type="password" class="form-control password-input-field" id="passphrase" name="passphrase"
                                               placeholder="パスワードを入力" autocomplete="off">
                                        <button type="button" class="password-toggle-btn" id="togglePassphrase" aria-label="パスワードの表示切替">
                                            <i class="bi bi-eye" aria-hidden="true"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">リンクにアクセスするためのパスワード（オプション）</div>
                                </div>

                                <!-- Memo -->
                                <div class="mb-3">
                                    <label for="memo" class="form-label">Memo</label>
                                    <textarea class="form-control" id="memo" name="memo" rows="3"
                                              placeholder="リンクに関するメモを入力"></textarea>
                                    <div class="form-text">このリンクに関するメモ（オプション）</div>
                                </div>

                                <!-- Tag -->
                                <div class="mb-3">
                                    <label for="tag" class="form-label">Tag</label>
                                    <input type="text" class="form-control" id="tag" name="tag"
                                           placeholder="tag1,tag2,tag3">
                                    <div class="form-text">カンマ区切りでタグを入力（オプション）</div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle"></i> キャンセル
                                </button>
                                <button type="button" class="btn btn-primary" id="submitButton">
                                    <i class="bi bi-check-circle"></i> 作成
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Edit Link Modal -->
            <div class="modal fade" id="editLinkModal" tabindex="-1" aria-labelledby="editLinkModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editLinkModalLabel">
                                <i class="bi bi-pencil"></i> リンク編集
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form id="editLinkForm" autocomplete="off">
                            <div class="modal-body">
                                <!-- Slug (読み取り専用) -->
                                <div class="mb-3">
                                    <label for="editLinkSlug" class="form-label">Slug</label>
                                    <input type="text" class="form-control" id="editLinkSlug" readonly>
                                    <div class="form-text">Slugは編集できません</div>
                                </div>

                                <div class="row">
                                    <!-- HTTP Status -->
                                    <div class="col-md-6 mb-3">
                                        <label for="editStatus" class="form-label">HTTP Status <span class="text-danger">*</span></label>
                                        <select class="form-select" id="editStatus" name="status" required>
                                            <option value="301">301 - Moved Permanently</option>
                                            <option value="302">302 - Found</option>
                                            <option value="303">303 - See Other</option>
                                            <option value="307">307 - Temporary Redirect</option>
                                            <option value="308">308 - Permanent Redirect</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Origin -->
                                <div class="mb-3">
                                    <label for="editLinkOrigin" class="form-label">Origin <span class="text-danger">*</span></label>
                                    <input type="url" class="form-control" id="editLinkOrigin" name="link_origin" required
                                           placeholder="https://example.com/destination" autocomplete="off">
                                    <div class="form-text">リダイレクト先のURL</div>
                                </div>

                                <div class="row">
                                    <!-- Limit -->
                                    <div class="col-md-6 mb-3">
                                        <label for="editMaxUses" class="form-label">Limit</label>
                                        <input type="number" class="form-control" id="editMaxUses" name="max_uses" min="1"
                                               placeholder="無制限" autocomplete="off">
                                        <div class="form-text">最大使用回数（空欄で無制限）</div>
                                    </div>

                                    <!-- Expiration Date -->
                                    <div class="col-md-6 mb-3">
                                        <label for="editExpirationDate" class="form-label">Expiration Date</label>
                                        <input type="datetime-local" class="form-control" id="editExpirationDate" name="expiration_date" autocomplete="off">
                                        <div class="form-text">有効期限（空欄で無期限）</div>
                                    </div>
                                </div>

                                <!-- Disabled -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="editDisabled" name="disabled" value="true">
                                        <label class="form-check-label" for="editDisabled">
                                            無効化（リンクを無効状態にする）
                                        </label>
                                    </div>
                                </div>

                                <!-- Query Settings -->
                                <div class="mb-3">
                                    <label class="form-label">Query String Settings</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="editQueryOmit" name="query_omit" value="true">
                                        <label class="form-check-label" for="editQueryOmit">
                                            クエリパラメータを除外
                                        </label>
                                    </div>
                                </div>

                                <!-- Query Whitelist -->
                                <div class="mb-3 hidden-field" id="editQueryWhitelistContainer">
                                    <label for="editQueryWhitelist" class="form-label">Query Whitelist</label>
                                    <input type="text" class="form-control" id="editQueryWhitelist" name="query_whitelist"
                                           placeholder="param1,param2,param3" disabled>
                                    <div class="form-text">カンマ区切りで許可するクエリパラメータ名を指定</div>
                                </div>

                                <!-- Expired Origin -->
                                <div class="mb-3">
                                    <label for="editExpiredOrigin" class="form-label">Expired Origin</label>
                                    <input type="url" class="form-control" id="editExpiredOrigin" name="expired_origin"
                                           placeholder="https://example.com/expired" autocomplete="off">
                                    <div class="form-text">期限切れ時のリダイレクト先URL（オプション）</div>
                                </div>

                                <!-- Passphrase -->
                                <div class="mb-3">
                                    <label for="editPassphrase" class="form-label">Passphrase</label>
                                    <div class="password-field-wrapper">
                                        <input type="password" class="form-control password-input-field" id="editPassphrase" name="passphrase"
                                               placeholder="パスワードを入力" autocomplete="off">
                                        <button type="button" class="password-toggle-btn" id="toggleEditPassphrase" aria-label="パスワードの表示切替">
                                            <i class="bi bi-eye" aria-hidden="true"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">リンクにアクセスするためのパスワード（オプション）</div>
                                </div>

                                <!-- Memo -->
                                <div class="mb-3">
                                    <label for="editMemo" class="form-label">Memo</label>
                                    <textarea class="form-control" id="editMemo" name="memo" rows="3"
                                              placeholder="リンクに関するメモを入力" autocomplete="off"></textarea>
                                    <div class="form-text">このリンクに関するメモ（オプション）</div>
                                </div>

                                <!-- Tag -->
                                <div class="mb-3">
                                    <label for="editTag" class="form-label">Tag</label>
                                    <input type="text" class="form-control" id="editTag" name="tag"
                                           placeholder="tag1,tag2,tag3" autocomplete="off">
                                    <div class="form-text">カンマ区切りでタグを入力（オプション）</div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle"></i> キャンセル
                                </button>
                                <button type="button" class="btn btn-primary" id="editSubmitButton">
                                    <i class="bi bi-check-circle"></i> 更新
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="text-center text-muted my-4">
                <small>&copy; 2025 Kazuhiro Oka</small>
            </footer>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>

        <!-- Custom JS -->
        <script {%- if script_nonce %} nonce="{{ script_nonce }}"{%- endif %}>
            // パスフレーズのバリデーション
            function validatePassphrase(passphrase) {
                if (!passphrase || passphrase === '') {
                    return { valid: true };
                }

                // 許可される文字: 英数字と -_/*+.!#$%&~@=^
                const passphrasePattern = /^[a-zA-Z0-9\-_/*+.!#$%&~@=^]+$/;
                if (!passphrasePattern.test(passphrase)) {
                    return { valid: false, message: 'パスフレーズに使用できない文字が含まれています。\n使用可能な文字: 英数字、-_/*+.!#$%&~@=^' };
                }

                return { valid: true };
            }

            // Query Omit チェックボックスの制御
            document.addEventListener('DOMContentLoaded', function() {
                // Bootstrap ツールチップの初期化
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });

                // パスワード表示トグル機能（作成モーダル）
                const togglePassphraseBtn = document.getElementById('togglePassphrase');
                const passphraseInput = document.getElementById('passphrase');
                if (togglePassphraseBtn && passphraseInput) {
                    togglePassphraseBtn.addEventListener('click', function() {
                        const isPassword = passphraseInput.type === 'password';
                        passphraseInput.type = isPassword ? 'text' : 'password';
                        const icon = togglePassphraseBtn.querySelector('i');
                        icon.classList.toggle('bi-eye');
                        icon.classList.toggle('bi-eye-slash');
                    });
                }

                // パスワード表示トグル機能（編集モーダル）
                const toggleEditPassphraseBtn = document.getElementById('toggleEditPassphrase');
                const editPassphraseInput = document.getElementById('editPassphrase');
                if (toggleEditPassphraseBtn && editPassphraseInput) {
                    toggleEditPassphraseBtn.addEventListener('click', function() {
                        const isPassword = editPassphraseInput.type === 'password';
                        editPassphraseInput.type = isPassword ? 'text' : 'password';
                        const icon = toggleEditPassphraseBtn.querySelector('i');
                        icon.classList.toggle('bi-eye');
                        icon.classList.toggle('bi-eye-slash');
                    });
                }

                const queryOmitCheckbox = document.getElementById('queryOmit');
                const queryWhitelistContainer = document.getElementById('queryWhitelistContainer');
                const queryWhitelistInput = document.getElementById('queryWhitelist');

                // チェックボックスの状態に応じてホワイトリスト入力欄を表示/非表示・有効/無効
                function updateQueryWhitelistState() {
                    if (queryOmitCheckbox.checked) {
                        queryWhitelistContainer.classList.add('hidden-field');
                        queryWhitelistInput.disabled = true;
                        queryWhitelistInput.value = '';
                    } else {
                        queryWhitelistContainer.classList.remove('hidden-field');
                        queryWhitelistInput.disabled = false;
                    }
                }

                // 初期状態を設定
                updateQueryWhitelistState();

                // チェックボックス変更時
                queryOmitCheckbox.addEventListener('change', updateQueryWhitelistState);

                // フォーム送信ボタンのクリックイベント
                const submitButton = document.getElementById('submitButton');
                submitButton.addEventListener('click', function(e) {
                    // イベント伝播を防止
                    e.preventDefault();
                    e.stopPropagation();

                    const slugInput = document.getElementById('linkSlug');
                    const slugPattern = /^[a-zA-Z0-9_\-/]+$/;

                    if (!slugInput.value) {
                        alert('Slugを入力してください。');
                        return;
                    }

                    if (!slugPattern.test(slugInput.value)) {
                        alert('Slugは英数字、ハイフン、アンダースコア、スラッシュのみ使用可能です。');
                        return;
                    }

                    const originInput = document.getElementById('linkOrigin');
                    if (!originInput.value) {
                        alert('Originを入力してください。');
                        return;
                    }

                    // パスフレーズのバリデーション
                    const passphrase = document.getElementById('passphrase').value;
                    const passphraseValidation = validatePassphrase(passphrase);
                    if (!passphraseValidation.valid) {
                        alert(passphraseValidation.message);
                        return;
                    }

                    // JSONデータを作成
                    const data = {
                        link_slug: document.getElementById('linkSlug').value,
                        link_origin: document.getElementById('linkOrigin').value,
                        status: parseInt(document.getElementById('status').value),
                        disabled: document.getElementById('disabled').checked,
                        query_omit: queryOmitCheckbox.checked
                    };

                    // オプショナルフィールドを追加
                    const maxUses = document.getElementById('maxUses').value;
                    if (maxUses) {
                        data.max_uses = parseInt(maxUses);
                    }

                    const expirationDate = document.getElementById('expirationDate').value;
                    if (expirationDate) {
                        // ISO 8601(with timezone)
                        data.expiration_date = (new Date(expirationDate)).toISOString();
                    }

                    const expiredOrigin = document.getElementById('expiredOrigin').value;
                    if (expiredOrigin) {
                        data.expired_origin = expiredOrigin;
                    }

                    if (passphrase) {
                        data.passphrase = passphrase;
                    }

                    const memo = document.getElementById('memo').value;
                    if (memo) {
                        data.memo = memo;
                    }

                    const tag = document.getElementById('tag').value;
                    if (tag) {
                        data.tag = tag.split(',').map(s => s.trim()).filter(s => s);
                    }

                    // query_omitがfalseの場合のみ、query_whitelistを送信
                    if (!queryOmitCheckbox.checked) {
                        const queryWhitelist = document.getElementById('queryWhitelist').value;
                        if (queryWhitelist) {
                            data.query_whitelist = queryWhitelist.split(',').map(s => s.trim()).filter(s => s);
                        }
                    }

                    // POSTリクエストを送信（JSON形式）
                    fetch('/{{link_prefix}}admin', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => {
                        if (response.ok) {
                            // 成功したらページをリロード
                            window.location.reload();
                        } else if(response.status === 409) { // CONFLICT
                            alert('指定したリンクはすでに存在しています。最新のリンク一覧を確認してください。');
                        } else {
                            // エラーの場合はアラート表示
                            return response.text().then(text => {
                                alert('エラーが発生しました: ' + (text || response.statusText));
                            });
                        }
                    })
                    .catch(error => {
                        alert('エラーが発生しました: ' + error.message);
                    });
                });

                // モーダルが閉じられたときにフォームをリセット
                const createLinkModal = document.getElementById('createLinkModal');
                const createLinkForm = document.getElementById('createLinkForm');
                createLinkModal.addEventListener('hidden.bs.modal', function() {
                    createLinkForm.reset();
                    updateQueryWhitelistState();

                    // パスワード入力欄を非表示状態にリセット
                    if (passphraseInput) {
                        passphraseInput.type = 'password';
                    }
                    if (togglePassphraseBtn) {
                        const icon = togglePassphraseBtn.querySelector('i');
                        if (icon) {
                            icon.classList.remove('bi-eye-slash');
                            icon.classList.add('bi-eye');
                        }
                    }
                });

                // === 編集機能 ===
                const editQueryOmitCheckbox = document.getElementById('editQueryOmit');
                const editQueryWhitelistContainer = document.getElementById('editQueryWhitelistContainer');
                const editQueryWhitelistInput = document.getElementById('editQueryWhitelist');

                // 編集モーダル用のホワイトリスト状態制御
                function updateEditQueryWhitelistState() {
                    if (editQueryOmitCheckbox.checked) {
                        editQueryWhitelistContainer.classList.add('hidden-field');
                        editQueryWhitelistInput.disabled = true;
                        editQueryWhitelistInput.value = '';
                    } else {
                        editQueryWhitelistContainer.classList.remove('hidden-field');
                        editQueryWhitelistInput.disabled = false;
                    }
                }

                // 編集チェックボックス変更時
                editQueryOmitCheckbox.addEventListener('change', updateEditQueryWhitelistState);

                // 編集ボタンのクリックイベント
                document.querySelectorAll('.edit-link-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        // data属性から値を取得
                        const slug = this.getAttribute('data-slug');
                        const origin = this.getAttribute('data-origin');
                        const status = this.getAttribute('data-status');
                        const disabled = this.getAttribute('data-disabled') === 'true';
                        const maxUses = this.getAttribute('data-max-uses');
                        const expiration = this.getAttribute('data-expiration');
                        const expiredOrigin = this.getAttribute('data-expired-origin');
                        const passphrase = this.getAttribute('data-passphrase');
                        const queryOmit = this.getAttribute('data-query-omit') === 'true';
                        const queryWhitelist = this.getAttribute('data-query-whitelist');
                        const memo = this.getAttribute('data-memo');
                        const tag = this.getAttribute('data-tag');

                        // フォームに値を設定
                        document.getElementById('editLinkSlug').value = slug;
                        document.getElementById('editLinkOrigin').value = origin;
                        document.getElementById('editStatus').value = status;
                        document.getElementById('editDisabled').checked = disabled;
                        document.getElementById('editMaxUses').value = maxUses;
                        document.getElementById('editExpirationDate').value = expiration;
                        document.getElementById('editExpiredOrigin').value = expiredOrigin;
                        document.getElementById('editQueryOmit').checked = queryOmit;
                        document.getElementById('editQueryWhitelist').value = queryWhitelist;
                        document.getElementById('editMemo').value = memo;
                        document.getElementById('editTag').value = tag;

                        // パスワードを表示（既存のパスワードを確認できるように）
                        document.getElementById('editPassphrase').value = passphrase;
                        document.getElementById('editPassphrase').type = 'password';
                        if (toggleEditPassphraseBtn) {
                            const icon = toggleEditPassphraseBtn.querySelector('i');
                            if (icon) {
                                icon.classList.remove('bi-eye-slash');
                                icon.classList.add('bi-eye');
                            }
                        }

                        // Query Whitelist の状態を更新
                        updateEditQueryWhitelistState();
                    });
                });

                // 編集フォーム送信ボタンのクリックイベント
                const editSubmitButton = document.getElementById('editSubmitButton');
                editSubmitButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const slug = document.getElementById('editLinkSlug').value;
                    const originInput = document.getElementById('editLinkOrigin');

                    if (!originInput.value) {
                        alert('Originを入力してください。');
                        return;
                    }

                    // パスフレーズのバリデーション
                    const editPassphrase = document.getElementById('editPassphrase').value;
                    const passphraseValidation = validatePassphrase(editPassphrase);
                    if (!passphraseValidation.valid) {
                        alert(passphraseValidation.message);
                        return;
                    }

                    // JSONデータを作成
                    const data = {
                        domain: '{{ domain }}',
                        link_slug: slug,
                        link_origin: originInput.value,
                        status: parseInt(document.getElementById('editStatus').value),
                        disabled: document.getElementById('editDisabled').checked,
                        query_omit: editQueryOmitCheckbox.checked
                    };

                    // オプショナルフィールドを追加
                    const maxUses = document.getElementById('editMaxUses').value;
                    if (maxUses) {
                        data.max_uses = parseInt(maxUses);
                    }

                    const expirationDate = document.getElementById('editExpirationDate').value;
                    if (expirationDate) {
                        data.expiration_date = (new Date(expirationDate)).toISOString();
                    }

                    const expiredOrigin = document.getElementById('editExpiredOrigin').value;
                    if (expiredOrigin) {
                        data.expired_origin = expiredOrigin;
                    }

                    if (editPassphrase) {
                        data.passphrase = editPassphrase;
                    }

                    const memo = document.getElementById('editMemo').value;
                    if (memo) {
                        data.memo = memo;
                    }

                    const tag = document.getElementById('editTag').value;
                    if (tag) {
                        data.tag = tag.split(',').map(s => s.trim()).filter(s => s);
                    }

                    // query_omitがfalseの場合のみ、query_whitelistを送信
                    if (!editQueryOmitCheckbox.checked) {
                        const queryWhitelist = editQueryWhitelistInput.value;
                        if (queryWhitelist) {
                            data.query_whitelist = queryWhitelist.split(',').map(s => s.trim()).filter(s => s);
                        }
                    }

                    // PUTリクエストを送信（JSON形式）
                    fetch('/{{link_prefix}}admin', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => {
                        if (response.ok) {
                            // 成功したらページをリロード
                            window.location.reload();
                        } else {
                            // エラーの場合はアラート表示
                            return response.text().then(text => {
                                alert('エラーが発生しました: ' + (text || response.statusText));
                            });
                        }
                    })
                    .catch(error => {
                        alert('エラーが発生しました: ' + error.message);
                    });
                });

                // 編集モーダルが閉じられたときにフォームをリセット
                const editLinkModal = document.getElementById('editLinkModal');
                const editLinkForm = document.getElementById('editLinkForm');
                editLinkModal.addEventListener('hidden.bs.modal', function() {
                    editLinkForm.reset();
                    updateEditQueryWhitelistState();

                    // パスワード入力欄を非表示状態にリセット
                    if (editPassphraseInput) {
                        editPassphraseInput.type = 'password';
                    }
                    if (toggleEditPassphraseBtn) {
                        const icon = toggleEditPassphraseBtn.querySelector('i');
                        if (icon) {
                            icon.classList.remove('bi-eye-slash');
                            icon.classList.add('bi-eye');
                        }
                    }
                });
            });
        </script>
    </body>
</html>
